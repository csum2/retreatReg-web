<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with OTP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="text" id="otp" placeholder="One Time Password">
        <button id="requestOtp">Request One Time Password (OTP)</button>
        <button id="login">Login</button>
    </div>

    <script>
        const sendOtpUrl = 'http://localhost:3000/sendOTP';
        const verifyOtpUrl = 'http://localhost:3000/verifyOTP';
        const requestOtpBtn = document.getElementById('requestOtp');
        const loginBtn = document.getElementById('login');
        const otpField = document.getElementById('otp');
        let countdownInterval;

        function validateEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        function startCountdown(seconds) {
            const currentTime = Math.floor(Date.now() / 1000);
            const endTime = currentTime + seconds;
            localStorage.setItem('otpCountdown', endTime);

            updateButtonText(`Wait ${seconds}s`);
            countdownInterval = setInterval(() => {
                const remainingTime = localStorage.getItem('otpCountdown') - Math.floor(Date.now() / 1000);
                if (remainingTime > 0) {
                    updateButtonText(`Wait ${remainingTime}s`);
                } else {
                    clearInterval(countdownInterval);
                    localStorage.removeItem('otpCountdown');  // Clear countdown after it ends
                    updateButtonText('Request One Time Password (OTP)');
                    requestOtpBtn.disabled = false;
                }
            }, 1000);
        }

        function updateButtonText(text) {
            requestOtpBtn.textContent = text;
        }

        // Function to restore countdown after page reload
        function restoreCountdown() {
            const savedEndTime = localStorage.getItem('otpCountdown');
            if (savedEndTime) {
                const remainingTime = savedEndTime - Math.floor(Date.now() / 1000);
                if (remainingTime > 0) {
                    requestOtpBtn.disabled = true;
                    startCountdown(remainingTime);  // Resume countdown from where it left off
                } else {
                    localStorage.removeItem('otpCountdown');  // Clear if expired
                }
            }
        }

        // Request OTP
        requestOtpBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            otpField.value = '';  // Clear the OTP field when requesting a new OTP

            if (!email) {
                alert('Please enter your email address');
                return;
            }
            if (!validateEmail(email)) {
                alert('Please enter a valid email');
                return;
            }

            // Disable the button immediately after click
            requestOtpBtn.disabled = true;
            updateButtonText('Processing...');

            try {
                const response = await fetch(sendOtpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email }),
                });

                if (response.ok) {
                    alert('OTP sent to your email');
                    startCountdown(60);  // Start the 60-second countdown after successful request
                } else {
                    alert('Failed to send OTP');
                    requestOtpBtn.disabled = false;  // Re-enable button on error
                    updateButtonText('Request One Time Password (OTP)');
                }
            } catch (error) {
                console.error('Error requesting OTP:', error);
                requestOtpBtn.disabled = false;  // Re-enable button on error
                updateButtonText('Request One Time Password (OTP)');
            }
        });

        // Login with OTP
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const otp = otpField.value;

            if (!email) {
                alert('Please enter your email');
                return;
            }

            if (!otp) {
                alert('Please enter the OTP');
                return;
            }

            try {
                const response = await fetch(verifyOtpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, otp }),
                });

                if (response.ok) {
                    alert('Login successful');
                } else {
                    alert('Invalid OTP');
                }
            } catch (error) {
                console.error('Error during login:', error);
            }
        });

        // Restore countdown if page is refreshed
        window.onload = restoreCountdown;

    </script>
</body>
</html>
