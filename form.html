<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat Registration Form</title>
    <link rel="stylesheet" href="style.css"> <!-- Link to external CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/4.0.0/spin.min.js"></script>
</head>
<body>
    <!-- Fullscreen loading indicator -->
    <div id="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    <button class="logout-btn" id="logoutBtn" style="width: auto;">&#10006;</button>
    <div class="container">
        <h2>Cornerstone Fellowship<br>Retreat Registration Form</h2>
        <p id="eventInfo1">
            The contact information of the person who completes the registration form will become the contact of that suite. All future communication will be under this registrant’s name, phone number and email. For sharing one suite, all registrants’ information has to be provided in the same registration form.
        </p>
        
        <input type="tel" id="phone" placeholder="Contact Mobile 123-456-7890" required>
        <span class="hint" id="hintPhone1">Contact mobile number is required</span>
        <p></p>
        <label for="numHouseHolds">Number of households in the unit:</label>
        <select id="numHouseHolds">
            <option value="1" selected>1</option>
            <option value="2">2</option>
        </select>

        <h3>Room 1</h3>
        <div class="name-group">
            <input type="text" id="firstName1" placeholder="First Name" required>
            <input type="text" id="lastName1" placeholder="Last Name" required>
        </div>
        <span class="hint" id="hintName1">First and Last Name are required</span>
        <div class="name-group">
            <input type="text" id="firstName2" placeholder="First Name" required>
            <input type="text" id="lastName2" placeholder="Last Name" required>
        </div>
        <span class="hint" id="hintName2" style="display: none;">Optional</span>

        <h3>Room 2</h3>
        <div class="name-group">
            <input type="text" id="firstName3" placeholder="First Name" required>
            <input type="text" id="lastName3" placeholder="Last Name" required>
        </div>
        <span class="hint" id="hintName3" style="display: none;">First and Last Name are required if 2 households</span>
        <div class="name-group">
            <input type="text" id="firstName4" placeholder="First Name" required>
            <input type="text" id="lastName4" placeholder="Last Name" required>
        </div>
        <span class="hint" id="hintName4" style="display: none;">Optional</span>

        <hr class="divider">

        <label>T-shirt Order details:</label>
        <p id="eventInfo2">
            The total number of T-shirts must match the number of people registered above.
        </p>
        
        <table id="tshirtOrderTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Size</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>
                        <select id="sizeSelect1" class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <div class="number-input">
                            <button class="spinner" onclick="adjustQty(-1, 'qtySpinner1')">-</button>
                            <input type="number" id="qtySpinner1" value="1" class="qtySpinner" min="0" max="4" oninput="this.value = Math.min(Math.max(this.value, 0), 4);">
                            <button class="spinner" onclick="adjustQty(1, 'qtySpinner1')">+</button>
                        </div>
                    </td>
                    </td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>
                        <select id="sizeSelect2" class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <div class="number-input">
                            <button class="spinner" onclick="adjustQty(-1, 'qtySpinner2')">-</button>
                            <input type="number" id="qtySpinner2" value="0" class="qtySpinner" min="0" max="4" oninput="this.value = Math.min(Math.max(this.value, 0), 4);">
                            <button class="spinner" onclick="adjustQty(1, 'qtySpinner2')">+</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>
                        <select id="sizeSelect3" class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <div class="number-input">
                            <button class="spinner" onclick="adjustQty(-1, 'qtySpinner3')">-</button>
                            <input type="number" id="qtySpinner3" value="0" class="qtySpinner" min="0" max="4" oninput="this.value = Math.min(Math.max(this.value, 0), 4);">
                            <button class="spinner" onclick="adjustQty(1, 'qtySpinner3')">+</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>
                        <select id="sizeSelect4" class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <div class="number-input">
                            <button class="spinner" onclick="adjustQty(-1, 'qtySpinner4')">-</button>
                            <input type="number" id="qtySpinner4" value="0" class="qtySpinner" min="0" max="4" oninput="this.value = Math.min(Math.max(this.value, 0), 4);">
                            <button class="spinner" onclick="adjustQty(1, 'qtySpinner4')">+</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <p id="eventInfo3">
            Please click the calculate button to see the total fees before you can submit the registration.
        </p>

        <p style="display: flex; justify-content: space-between; align-items: center;">
            <span id="totalFee">Total Fee: $<span id="feeAmount">0.00</span></span>
            <button id="calculateFee" style="width: auto;">Calculate</button>
        </p>

        <button id="clearInput">Clear</button>
        <button id="submitForm" disabled>Submit</button>
    </div>

    <script>
        // Determine the environment
        let baseUrl;
        baseUrl = 'https://retreatreg-rest.fly.dev';

        const saveOrUpdateUrl = `${baseUrl}/saveOrUpdate`;
        var userDataEmail;
        var userDataRegDate;
        var userDataUpdTimestamp;

        if (!sessionStorage.getItem("isLoggedIn")) {
            // Redirect to login page if not logged in
            clearStorage();
            window.location.href = "index.html";
        }
        // Jump back to login page if the user email is not saved previously
        const uData = localStorage.getItem('userData');
        if (uData === null || uData === "") {
            console.log("User data is missing in the local storage.");
            clearStorage();
            window.location.href = "index.html";
        } else {
            console.log("uData:", uData);
        }

        // Clear storage
        function clearStorage() {
            localStorage.removeItem('loginTimestamp');
            sessionStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userData');
        }

        function checkLoginStatus() {
            /* TODO comment out for unit test */
            const loginTimestamp = localStorage.getItem('loginTimestamp');
            //24 hours timeout
            if (!loginTimestamp || (Date.now() - loginTimestamp) > 86400000) {
                Swal.fire({
                    title: 'Session Expired!',
                    text: 'You have been logged out due to inactivity. Please log in again.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return false;
            }
            return true;
        }

        // Function to set the selected value of a pulldown menu
        function setSelectedValue(selectElement, value) {
            if (value !== undefined && value !== null) {
                selectElement.value = value;
            }
        }

        function adjustQty(amount, spinnerId) {
            const spinner = document.getElementById(spinnerId);
            let currentValue = parseInt(spinner.value) || 0;
            currentValue = Math.min(Math.max(currentValue + amount, 0), 4); // Keep within 0-4
            spinner.value = currentValue;
        }

        // Load existing user data from localStorage
        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            const userDataJSON = JSON.stringify(userData);
            console.log(`User data loaded: ${userDataJSON}`);
            if (userData) {
                userDataEmail = userData.email;
                document.getElementById('phone').value = userData.mobile || '';

                const householdSelect = document.getElementById('numHouseHolds');
                setSelectedValue(householdSelect, userData.numOfHH);

                document.getElementById('firstName1').value = userData.names[0].firstName || '';
                document.getElementById('lastName1').value  = userData.names[0].lastName  || '';
                document.getElementById('firstName2').value = userData.names[1].firstName || '';
                document.getElementById('lastName2').value  = userData.names[1].lastName  || '';
                document.getElementById('firstName3').value = userData.names[2].firstName || '';
                document.getElementById('lastName3').value  = userData.names[2].lastName  || '';
                document.getElementById('firstName4').value = userData.names[3].firstName || '';
                document.getElementById('lastName4').value  = userData.names[3].lastName  || '';

                const sizeSelect1 = document.getElementById('sizeSelect1');
                setSelectedValue(sizeSelect1, userData.tshirts[0].size); 
                document.getElementById('qtySpinner1').value = userData.tshirts[0].qty;

                const sizeSelect2 = document.getElementById('sizeSelect2');
                setSelectedValue(sizeSelect2, userData.tshirts[1].size); 
                document.getElementById('qtySpinner2').value = userData.tshirts[1].qty;

                const sizeSelect3 = document.getElementById('sizeSelect3');
                setSelectedValue(sizeSelect3, userData.tshirts[2].size); 
                document.getElementById('qtySpinner3').value = userData.tshirts[2].qty;

                const sizeSelect4 = document.getElementById('sizeSelect4');
                setSelectedValue(sizeSelect4, userData.tshirts[3].size); 
                document.getElementById('qtySpinner4').value = userData.tshirts[3].qty;

                document.getElementById('feeAmount').textContent =
                    (userData.totalFee !== undefined && userData.totalFee !== null) ? parseFloat(userData.totalFee).toFixed(2) : '0.00';

                userDataRegDate = userData.regDate;
                userDataUpdTimestamp = userData.updTimestamp;
            }
        }

        window.onpopstate = function(event) {
            window.history.pushState(null, document.title, window.location.href);
        };

        // Check login status on page load
        window.onload = () => {
            if (!checkLoginStatus()) return;

            // Prevent going back to this page
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.pushState(null, null, location.href);
            };
            loadUserData(); // Load user data from localStorage
        };
        
        const phoneInput = document.getElementById('phone');
        const numHouseHoldsSelect = document.getElementById('numHouseHolds');
        const firstNameInputs = [
            document.getElementById('firstName1'), 
            document.getElementById('firstName2'), 
            document.getElementById('firstName3'), 
            document.getElementById('firstName4')
        ];
        const lastNameInputs = [
            document.getElementById('lastName1'), 
            document.getElementById('lastName2'), 
            document.getElementById('lastName3'), 
            document.getElementById('lastName4')
        ];
        const submitButton = document.getElementById('submitForm');
        const qtySpinners = document.querySelectorAll('.qtySpinner');

        document.addEventListener('DOMContentLoaded', function() {
            function updateNameFields() {
                const numHouseHolds = parseInt(numHouseHoldsSelect.value);
                firstNameInputs[0].required = true; // Name 1 is always required
                lastNameInputs[0].required  = true; // Name 1 is always required
                firstNameInputs[1].required = false; // Name 2 is not required
                lastNameInputs[1].required  = false; // Name 2 is not required
                firstNameInputs[2].required = (numHouseHolds === 2); // Name 3 is required only if 2 households
                lastNameInputs[2].required  = (numHouseHolds === 2); // Name 3 is required only if 2 households
                firstNameInputs[3].required = false; // Name 4 is not required
                lastNameInputs[3].required  = false; // Name 4 is not required
                
                // Update hints based on the number of households
                // Show Name 3 hint if 2 households
                document.getElementById('hintName3').style.display = 
                    (numHouseHolds === 2 && (firstNameInputs[2].value.trim() === "" || lastNameInputs[2].value.trim() === "")) ? 'inline' : 'none';
            }

            numHouseHoldsSelect.addEventListener('change', updateNameFields);

            // Function to validate phone number format
            function validatePhone() {
                var phoneValue = phoneInput.value;
                
                // Regular expression for validating North American phone numbers
                var phonePattern = /^(?:\(\d{3}\)|\d{3})[-.\s]?\d{3}[-.\s]?\d{4}$/;
                
                if (phonePattern.test(phoneValue)) {
                    return true;
                } else {
                    return false;
                }
            }

            // Function to check if all required fields are filled
            function checkRequiredFields() {
                const isPhoneValid = validatePhone();
                const isName1Valid = firstNameInputs[0].checkValidity() && lastNameInputs[0].checkValidity();
                const isName3Valid = numHouseHoldsSelect.value == '2' ? (firstNameInputs[2].checkValidity() && lastNameInputs[0].checkValidity()) : true; // Only check Name 3 if 2 households
                
                // Check if T-shirt count is equal to the number of persons
                const personCount = Array.from(firstNameInputs).filter(input => input.value.trim() !== '').length;
                const tShirtCount = Array.from(qtySpinners).reduce((total, qty) => total + parseInt(qty.value, 10), 0);
                const isTshirtQtyValid = (tShirtCount == personCount);

                return isPhoneValid && isName1Valid && isName3Valid && isTshirtQtyValid;
            }

            // Disable submit button initially
            submitButton.disabled = true;

            // Enable/disable hints based input fields
            firstNameInputs.forEach(input => {
                input.addEventListener('input', function() {
                    submitButton.disabled = true;
                    if (input === firstNameInputs[2]) {
                        if ((firstNameInputs[2].value.trim() === "" || lastNameInputs[2].value.trim() === "") && parseInt(numHouseHoldsSelect.value) === 2) {
                            document.getElementById('hintName3').style.display = "inline"
                        } else {
                            document.getElementById('hintName3').style.display = "none"
                        }
                    }
                });
            });

            // Enable/disable submit button based on T-shirt qty changed
            qtySpinners.forEach(change => {
                change.addEventListener('change', function() {
                    submitButton.disabled = true;
                });
            });

            // Function to select the spinner content on focus
            function selectSpinnerContent(event) {
                event.target.select(); // Select the input content
            }

            // Spinner fields allow only numeric inputs and select the content if got focus
            qtySpinners.forEach(spinner => {
                spinner.addEventListener('input', function (e) {
                    // If the input is not a number, set it to 0
                    if (isNaN(this.value) || this.value === '') {
                        this.value = 0;
                    }
                });
                spinner.addEventListener('focus', selectSpinnerContent);
            });

            // Calculate Total Fee
            function calculateTotalFee() {
                const onePersonFee = 170;
                const twoPersonFee = 125;
                const threePersonFee = 110;
                const fourPersonFee = 102;

                let numberOfPeople = 0;     // To count the number of people
                let feeToPay = 0;           // total fee to be paid

                firstNameInputs.forEach(input => {
                    if (input.value.trim() !== '') { // Check for non-blank input
                        numberOfPeople++; // Increment number of people for each non-blank input
                    }
                });

                if (numberOfPeople == 1) {
                    feeToPay = onePersonFee;
                } else if (numberOfPeople == 2) {
                    feeToPay = twoPersonFee * 2;
                } else if (numberOfPeople == 3) {
                    feeToPay = threePersonFee * 3;
                } else if (numberOfPeople == 4) {
                    feeToPay = fourPersonFee * 4;
                }

                document.getElementById('feeAmount').textContent = `${feeToPay.toFixed(2)}`;
                // Disable submit button if no additional payment is required
                submitButton.disabled = (feeToPay === 0); 
            }

            document.getElementById('calculateFee').addEventListener('click', calculateTotalFee);

            // Clear form
            document.getElementById('clearInput').addEventListener('click', () => {
                // clear mobile number
                document.getElementById('phone').value = '';

                // Clear name inputs
                firstNameInputs.forEach(input => {
                    input.value = ''; // Clear the input value
                });
                lastNameInputs.forEach(input => {
                    input.value = ''; // Clear the input value
                });

                // Reset household count to default
                numHouseHoldsSelect.selectedIndex = 0; // Reset to the first option (1 household)

                // Reset select elements
                document.querySelectorAll(' .sizeSelect').
                    forEach(select => {
                    select.selectedIndex = 0; // Reset to the first option
                });

                // Reset the spinners
                qtySpinners.forEach(spinner => {
                    spinner.value = 0;
                });

                // Reset total fee
                document.getElementById('feeAmount').textContent = '0.00';

                // Disable the submit button
                submitButton.disabled = true;

                // Re-initialize the name fields based on the reset number of households
                updateNameFields();
            });

            // Post the form inputs to the backend
            function saveToBackend() {
                // Gather data and build the JSON object
                const email = userDataEmail;
                const numOfHH = document.getElementById("numHouseHolds").value;

                //Gather first names and last names
                const names = [];
                for (let i = 1; i <= 4; i++) {
                    names.push({
                        firstName: document.getElementById("firstName" + i).value,
                        lastName: document.getElementById("lastName" + i).value,
                    });
                }

                const mobile = document.getElementById("phone").value;

                // Gather T-shirt orders
                const tshirts = [];
                for (let i = 1; i <= 4; i++) {
                    tshirts.push({
                        size: document.getElementById("sizeSelect" + i).value,
                        qty: document.getElementById("qtySpinner" + i).value
                    });
                }

                const totalFee = document.getElementById("feeAmount").textContent;

                // Build the JSON object
                const formData = {
                    email: email,
                    numOfHH: parseInt(numOfHH),
                    names: names,
                    mobile: mobile,
                    tshirts: tshirts,
                    totalFee: totalFee
                };
                console.log('Form data json:', JSON.stringify(formData));

                // Show loading indicator
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.style.display = 'flex';

                // Send the POST request to /saveOrUpdate
                fetch(saveOrUpdateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Post save/update success:', data);
                    Swal.fire({
                            icon: 'success',
                            title: 'Registration Submitted',
                            text: 'Your registration has been submitted successfully.',
                            confirmButtonText: 'OK'
                        }).then(()=>{
                            clearStorage();
                            window.location.href = 'index.html';
                        }
                    );
                })
                .catch((error) => {
                // Handle any errors
                    console.error('Post save/update Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'System error',
                        text: 'There was an error submitting the form. Please retry',
                        confirmButtonText: 'Proceed',
                    });
                })
                .finally(() => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                });
            }

            document.getElementById('submitForm').addEventListener('click', () => {
                if (!checkLoginStatus()) return;

                if (!checkRequiredFields()) {
                    let missingFields = [];
                    if (!validatePhone()) missingFields.push('Contact mobile');
                    if (!firstNameInputs[0].checkValidity()) missingFields.push('First Name 1');
                    if (!lastNameInputs[0].checkValidity()) missingFields.push('Last Name 1');
                    if (numHouseHoldsSelect.value === '2' && !firstNameInputs[2].checkValidity()) missingFields.push('First Name 3');
                    if (numHouseHoldsSelect.value === '2' && !lastNameInputs[2].checkValidity()) missingFields.push('Last Name 3');

                    const personCount = Array.from(firstNameInputs).filter(input => input.value.trim() !== '').length;
                    const tShirtCount = Array.from(qtySpinners).reduce((total, qty) => total + parseInt(qty.value, 10), 0);
                    if (tShirtCount != personCount) missingFields.push('Number of T-shirts and people not matching');

                    Swal.fire({
                        icon: 'error',
                        title: 'Missing / Invalid Fields',
                        text: `Please check out the field(s): ${missingFields.join(', ')}`,
                        confirmButtonText: 'OK'
                    });
                } else {
                    // Post the record to the backend
                    saveToBackend();
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                clearStorage();
                window.location.href = 'index.html';
            });

            // Initial setup
            updateNameFields();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
               (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || 
               (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
