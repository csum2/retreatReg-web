<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat Registration Form</title>
    <link rel="stylesheet" href="/style.css"> <!-- Link to external CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <button class="logout-btn" id="logoutBtn" style="width: auto;">&#10006;</button>
    <div class="container">
        <h2>Retreat Registration Form</h2>
        <p id="eventInfo1">
            Please note that no matter how many persons (up to four) stay in the unit, you will pay the resident a fixed fee of $999. Besides, each person has to pay for a meal plan of $200. The meal plan includes two meals per day for two days. There are no partial meal plans available.
        </p>
        
        <label for="numFamilies">Number of families in the unit:</label>
        <select id="numFamilies">
            <option value="1">1</option>
            <option value="2">2</option>
        </select>

        <h3>Room 1</h3>
        <input type="text" id="name1" placeholder="Name 1" required>
        <span class="hint" id="hintName1">Name 1 is equired</span>
        <input type="text" id="name2" placeholder="Name 2">
        <span class="hint" id="hintName2" style="display: none;">Optional</span>

        <h3>Room 2</h3>
        <input type="text" id="name3" placeholder="Name 3">
        <span class="hint" id="hintName3" style="display: none;">Name 3 is required if 2 families</span>
        <input type="text" id="name4" placeholder="Name 4">
        <span class="hint" id="hintName4" style="display: none;">Optional</span>

        <hr class="divider">

        <label>T-shirt Order details:</label>
        <p id="eventInfo2">
            The price for each T-shirt is $20. Please select the color, size, and quantity.
        </p>
        
        <table id="tshirtOrderTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Color</th>
                    <th>Size</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>
                        <select class="colorSelect">
                            <option value="Black" selected>Black</option>
                            <option value="White">White</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Red">Red</option>
                        </select>
                    </td>
                    <td>
                        <select class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <select class="qtySelect">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
                <!-- Repeat for rows 2, 3, and 4 as needed -->
                <tr>
                    <td>2</td>
                    <td>
                        <select class="colorSelect">
                            <option value="Black" selected>Black</option>
                            <option value="White">White</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Red">Red</option>
                        </select>
                    </td>
                    <td>
                        <select class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <select class="qtySelect">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>
                        <select class="colorSelect">
                            <option value="Black" selected>Black</option>
                            <option value="White">White</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Red">Red</option>
                        </select>
                    </td>
                    <td>
                        <select class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <select class="qtySelect">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>
                        <select class="colorSelect">
                            <option value="Black" selected>Black</option>
                            <option value="White">White</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Red">Red</option>
                        </select>
                    </td>
                    <td>
                        <select class="sizeSelect">
                            <option value="S" selected>S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </td>
                    <td>
                        <select class="qtySelect">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
            </tbody>
        </table>
        <p id="eventInfo3">
            Please click the calculate button to see the total fees before you submit the registration.
        </p>

        <p style="display: flex; justify-content: space-between; align-items: center;">
            <span id="totalFee">Total Fee: $0.00</span>
            <button id="calculateFee" style="width: auto;">Calculate</button>
        </p>

        <button id="clearInput">Clear</button>
        <button id="submitForm" disabled>Submit</button>
    </div>

    <script>
        function checkLoginStatus() {
            /* TODO comment out for unit test
            const loginTimestamp = localStorage.getItem('loginTimestamp');
            //24 hours timeout
            if (!loginTimestamp || (Date.now() - loginTimestamp) > 86400000) {
                Swal.fire({
                    title: 'Session Expired!',
                    text: 'You have been logged out due to inactivity. Please log in again.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return false;
            }
            */
            return true;
        }

        // Load existing user data from localStorage
        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData && userData.names) {
                document.getElementById('name1').value = userData.names[0] || '';
                document.getElementById('name2').value = userData.names[1] || '';
                document.getElementById('name3').value = userData.names[2] || '';
                document.getElementById('name4').value = userData.names[3] || '';
            }
        }

        window.onpopstate = function(event) {
            window.history.pushState(null, document.title, window.location.href);
        };

        // Check login status on page load
        window.onload = () => {
            if (!checkLoginStatus()) return;

            // Prevent going back to this page
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.pushState(null, null, location.href);
            };
            loadUserData(); // Load user data from localStorage
        };
        
        const numFamiliesSelect = document.getElementById('numFamilies');
        const nameInputs = [
            document.getElementById('name1'), 
            document.getElementById('name2'), 
            document.getElementById('name3'), 
            document.getElementById('name4')
        ];
        const submitButton = document.getElementById('submitForm');
        const qtySelects = document.querySelectorAll('.qtySelect');

        document.addEventListener('DOMContentLoaded', function() {
            function updateNameFields() {
                const numFamilies = parseInt(numFamiliesSelect.value);
                nameInputs[0].required = true; // Name 1 is always required
                nameInputs[1].required = false; // Name 2 is not required
                nameInputs[2].required = (numFamilies === 2); // Name 3 is required only if 2 families
                nameInputs[3].required = false; // Name 4 is not required
                
                // Update hints based on the number of families
                document.getElementById('hintName1').style.display = 'inline'; // Always show
                document.getElementById('hintName2').style.display = 'none'; // Hide Name 2 hint
                document.getElementById('hintName3').style.display = (numFamilies === 2) ? 'inline' : 'none'; // Show Name 3 hint if 2 families
                document.getElementById('hintName4').style.display = 'none'; // Hide Name 4 hint
            }

            numFamiliesSelect.addEventListener('change', updateNameFields);

            // Function to check if all required fields are filled
            function checkRequiredFields() {
                const isName1Valid = nameInputs[0].checkValidity();
                const isName3Valid = numFamiliesSelect.value == '2' ? nameInputs[2].checkValidity() : true; // Only check Name 3 if 2 families
                return isName1Valid && isName3Valid;
            }

            // Disable submit button initially
            submitButton.disabled = true;

            // Enable/disable submit button based input fields
            nameInputs.forEach(input => {
                input.addEventListener('input', function() {
                    submitButton.disabled = true;
                });
            });
            
            // Enable/disable submit button based on T-shirt qty changed
            qtySelects.forEach(change => {
                change.addEventListener('change', function() {
                    submitButton.disabled = true;
                });
            });

            // Calculate Total Fee
            function calculateTotalFee() {
                let total = 999; // Fixed fee for a residence
                let tShirtCount = 0;

                // Add meal plan fee of $200 for each person
                nameInputs.forEach(input => {
                    if (input.value.trim() !== '') { // Check for non-blank input
                        total += 200;
                    }
                });

                // Add T-shirt order qty amount $20 / pcs
                qtySelects.forEach(select => {
                    tShirtCount += parseInt(select.value);
                });
                total += tShirtCount * 20; // Add T-shirt costs

                document.getElementById('totalFee').textContent = `Total Fee: $${total.toFixed(2)}`;
                //submitButton.disabled = total === 999 || !checkRequiredFields();
                submitButton.disabled = total === 999
            }

            document.getElementById('calculateFee').addEventListener('click', calculateTotalFee);

            // Clear form
            document.getElementById('clearInput').addEventListener('click', () => {
                // Clear name inputs
                nameInputs.forEach(input => {
                    input.value = ''; // Clear the input value
                });

                // Reset family count to default
                numFamiliesSelect.selectedIndex = 0; // Reset to the first option (1 family)

                // Reset select elements
                document.querySelectorAll('.colorSelect, .sizeSelect, .qtySelect').forEach(select => {
                    select.selectedIndex = 0; // Reset to the first option
                });

                // Reset total fee
                document.getElementById('totalFee').textContent = 'Total Fee: $0.00';

                // Disable the submit button
                submitButton.disabled = true;

                // Re-initialize the name fields based on the reset number of families
                updateNameFields();
            });

            document.getElementById('submitForm').addEventListener('click', () => {
                if (!checkLoginStatus()) return;

                if (!checkRequiredFields()) {
                    let missingFields = [];
                    if (!nameInputs[0].checkValidity()) missingFields.push('Name 1');
                    if (numFamiliesSelect.value === '2' && !nameInputs[2].checkValidity()) missingFields.push('Name 3');

                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Fields',
                        text: `Please fill in the following fields: ${missingFields.join(', ')}`,
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Order Submitted',
                        text: 'Your order has been submitted successfully.',
                        confirmButtonText: 'OK'
                    }).then(()=>{
                        //TODO disable for unit test
                        //clearStorage();
                        //window.location.href = 'index.html';
                    });
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                clearStorage();
                window.location.href = 'index.html';
            });

            // Clear storage
            function clearStorage() {
                localStorage.removeItem('loginTimestamp');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userData');
            }

            // Initial setup
            updateNameFields();
        });
    </script>
</body>
</html>
